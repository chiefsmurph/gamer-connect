<html>
<head>
  <title>City Leaders</title>
  <Style>
  .noselect {
    -webkit-touch-callout: none; /* iOS Safari */
      -webkit-user-select: none; /* Chrome/Safari/Opera */
       -khtml-user-select: none; /* Konqueror */
         -moz-user-select: none; /* Firefox */
          -ms-user-select: none; /* Internet Explorer/Edge */
              user-select: none; /* Non-prefixed version, currently
                                    not supported by any browser */
  }
  h1, p {
    margin: 0;
  }
  #container > h1 {
    padding: 6px 0 0 6px;
  }
  h2 {
    margin: 0 0 10px 0;
  }
  p {
    margin-bottom: 1em;
  }
  #nearbyCitiesView {
    display: none;
  }
  body * {
    font-family: 'Audiowide', cursive;
  }
  html, body {
    overflow: hidden;
    padding: 0;
    margin: 0;
  }
  body {
    padding: 1px;
  }
  #nav {
    display: flex;
    justify-content: space-around;
    margin: 0 0 10px;
  }
  .page {
    margin: 0 4px;
    overflow-y: scroll;
  }
  #nav a {
    background-color: #eee;
    padding: 10px;
    margin: 0.4vw;
    flex-grow: 1;
    text-align: center;
    color: blue;
  }
  a:visited {
    color: blue;
  }
  #nav a:hover {
    background-color: #ccc;
  }
  #nav a.currentPage {
    cursor: default;
    background-color: #ccc;
  }
  #container {
    display: none;
    font-size: 130%;
  }

  @media (max-width: 800px) {
    #container {
      font-size: 18px;
    }
    #nav a {
      font-size: 3.5vw;
      padding: 1vw;
    }
  }


  form {

  }
  label input#username {
    margin-left: 10px;
    padding: 2px 10px;
    max-width: 100%;
    font-size: 22px;
  }
  button {
    font-size: 21px;
    padding: 5px 15px;
    white-space: normal;
    border: 2px solid black;
    background-color: #e9e9e9;
    border-radius: 10px;
    outline-width: 0;
    cursor: pointer;
  }
  .no-touch button:hover {
    background-color: lightgoldenrodyellow;
  }
  button:active, button:focus {
    background-color: #e9e9e9;
  }
  button#join {
    display: none;
    font-weight: bold;
  }
  #getCurrentPosition {
    margin-bottom: 10px;
  }
  .red {
    color: red;
  }
  .green {
    color: green;
  }
  #curCity {
    font-weight: bold;
    font-size: 135%;
    color: green;
  }
  #curLeader {
    font-size: 150%;
    white-space: nowrap;
  }
  #nearbyCallout {
    font-size: 80%;
    color: grey;
    font-style: italic;
  }
  #your-portal #your-cities {
    display: none;
  }
  #conquer-cities > div {
    margin-bottom: 1em;
  }
  #conquer-cities button {
    margin-top: 10px;
  }
  #leaderboard table {
    font-size: 220%;
  }
  #leaderboard thead {
    letter-spacing: 2px;
  }
  #leaderboard thead th:first-of-type {
    width: 5%;
  }
  #leaderboard > * {
    cursor: default;
  }
  #leaderboard #tooltip {
    position: absolute;
    background-color: white;
    border: 1px solid black;
    padding: 15px;
  }
  #leaderboard #tooltip h3 {
    margin:  0;
    text-decoration: underline
  }
  #attackResults {
    margin-top: 1em;
  }
  #leaderboard #tables {
    margin: 0 -4px;
    position: relative;
  }
  .datagrid {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
  }
  .datagrid table { border-collapse: collapse; text-align: left; width: 100%; font-size: 80%; } .datagrid {font: normal 12px/150% Arial, Helvetica, sans-serif; background: #fff; overflow: hidden; border: 1px solid #006699; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; }.datagrid table td, .datagrid table th { padding: 3px 10px; }.datagrid table thead th {background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #006699), color-stop(1, #00557F) );background:-moz-linear-gradient( center top, #006699 5%, #00557F 100% );filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#006699', endColorstr='#00557F');background-color:#006699; color:#ffffff; font-weight: bold; border-left: 1px solid #0070A8; } .datagrid table thead th:first-child { border: none; }.datagrid table tbody td { color: #00496B; border-left: 1px solid #E1EEF4;font-weight: normal; }.datagrid table tbody .alt td { background: #E1EEF4; color: #00496B; }.datagrid table tbody td:first-child { border-left: none; }.datagrid table tbody tr:last-child td { border-bottom: none; }.datagrid table tfoot td div { border-top: 1px solid #006699;background: #E1EEF4;} .datagrid table tfoot td { padding: 0; } .datagrid table tfoot td div{ padding: 2px; }.datagrid table tfoot td ul { margin: 0; padding:0; list-style: none; text-align: right; }.datagrid table tfoot  li { display: inline; }.datagrid table tfoot li a { text-decoration: none; display: inline-block;  padding: 2px 8px; margin: 1px;color: #FFFFFF;border: 1px solid #006699;-webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #006699), color-stop(1, #00557F) );background:-moz-linear-gradient( center top, #006699 5%, #00557F 100% );filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#006699', endColorstr='#00557F');background-color:#006699; }.datagrid table tfoot ul.active, .datagrid table tfoot ul a:hover { text-decoration: none;border-color: #006699; color: #FFFFFF; background: none; background-color:#00557F;}div.dhtmlx_window_active, div.dhx_modal_cover_dv { position: fixed !important; }
  .overall {
    display: none;
  }
  .overall table thead th {background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #993300), color-stop(1, #99001a) );background:-moz-linear-gradient( center top, #993300 5%, #99001a 100% );filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#993300', endColorstr='##99001a');background-color:#993300; color:#ffffff; font-weight: bold; border-left: 1px solid #0070A8; } .datagrid table thead th:first-child { border: none; }.datagrid table tbody td { color: #00496B; border-left: 1px solid #E1EEF4;font-weight: normal; }.datagrid table tbody .alt td { background: #E1EEF4; color: #00496B; }.datagrid table tbody td:first-child { border-left: none; }.datagrid table tbody tr:last-child td { border-bottom: none; }.datagrid table tfoot td div { border-top: 1px solid #006699;background: #E1EEF4;} .datagrid table tfoot td { padding: 0; } .datagrid table tfoot td div{ padding: 2px; }.datagrid table tfoot td ul { margin: 0; padding:0; list-style: none; text-align: right; }.datagrid table tfoot  li { display: inline; }.datagrid table tfoot li a { text-decoration: none; display: inline-block;  padding: 2px 8px; margin: 1px;color: #FFFFFF;border: 1px solid #006699;-webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #006699), color-stop(1, #00557F) );background:-moz-linear-gradient( center top, #006699 5%, #00557F 100% );filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#006699', endColorstr='#00557F');background-color:#006699; }.datagrid table tfoot ul.active, .datagrid table tfoot ul a:hover { text-decoration: none;border-color: #006699; color: #FFFFFF; background: none; background-color:#00557F;}div.dhtmlx_window_active, div.dhx_modal_cover_dv { position: fixed !important; }
  /*993300*/
  .modal {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 70%;
    height: 70%;
    background-color: rgba(0,200,10,0.9);
    border-top: 10px solid green;
    padding: 10px;
    display: none;
    text-align: center;
  }

  .modal.beingAttacked, .modal#attackFailed, .modal#dethroned {
    background-color: rgba(200,10,10,0.9);
    border-top: 10px solid red;
  }

  /*leaderboard switch*/
  #period-chooser {
  	display: -ms-flexbox;
  	display: -webkit-flex;
  	display: flex;

  	-ms-flex-align: center;
  	-webkit-align-items: center;
  	-webkit-box-align: center;

  	align-items: center;
    justify-content: center;

    margin-bottom: 1vh;
    height: 67px;
  }
  #period-chooser > div {
    flex-basis: 100%;
  }
  #period-chooser b {
    text-transform: uppercase;
    font-size: calc(1vw + 10px);
  }
  .no-touch #period-chooser b {
    -webkit-transition: font-size 1s;
       -moz-transition: font-size 1s;
         -o-transition: font-size 1s;
            transition: font-size 1s;
            color: grey;
  }
  #period-chooser .selectedPeriod b {
    font-size: calc(2vw + 15px);
    color: black;
  }
  #period-chooser > div:nth-child(1) {
    padding-right: 2.5vw;
    text-align: right;
  }
  #period-chooser > div:nth-child(2) {
    flex-basis: 3%;
    padding-left: 0px;
  }
  #period-chooser > div:not(.selectedPeriod) b {
    cursor: pointer;
  }
  #period-chooser > div:nth-child(3) {
    padding-left: 2.5vw;
  }
  .cmn-toggle {
    position: absolute;
    margin-left: -9999px;
    cursor: pointer;
    visibility: hidden;
  }
  @media (max-width: 800px) {
    body:not(.no-touch) #container > h1 {
      text-align: center;
    }
    body:not(.no-touch) #period-chooser {
      margin-left: -20px;
    }
    #period-chooser .switch {
      zoom: 50%;
    }
    body:not(.no-touch) .datagrid th {
      font-size: 60%;
    }
    body:not(.no-touch) #period-chooser > div:nth-child(3) {
      padding-left: 65px;
    }
    period-chooser > div:nth-child(1) {
      margin-left: -10px;
    }
  }
  #period-chooser .switch {
    position: relative;
  }
  .cmn-toggle + label {
    display: block;
    position: relative;
    cursor: pointer;
    outline: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    cursor: pointer;
  }
  input.cmn-toggle-round-flat + label {
    padding: 2px;
    width: 120px;
    height: 60px;
    background-color: #006699;
    -webkit-border-radius: 60px;
    -moz-border-radius: 60px;
    -ms-border-radius: 60px;
    -o-border-radius: 60px;
    border-radius: 60px;
    -webkit-transition: background 0.4s;
    -moz-transition: background 0.4s;
    -o-transition: background 0.4s;
    transition: background 0.4s;
  }
  input.cmn-toggle-round-flat + label:before, input.cmn-toggle-round-flat + label:after {
    display: block;
    position: absolute;
    content: "";
  }
  input.cmn-toggle-round-flat + label:before {
    top: 2px;
    left: 2px;
    bottom: 2px;
    right: 2px;
    background-color: #fff;
    -webkit-border-radius: 60px;
    -moz-border-radius: 60px;
    -ms-border-radius: 60px;
    -o-border-radius: 60px;
    border-radius: 60px;
    -webkit-transition: background 0.4s;
    -moz-transition: background 0.4s;
    -o-transition: background 0.4s;
    transition: background 0.4s;
  }
  input.cmn-toggle-round-flat + label:after {
    top: 4px;
    left: 4px;
    bottom: 4px;
    width: 52px;
    background-color: #006699;
    -webkit-border-radius: 52px;
    -moz-border-radius: 52px;
    -ms-border-radius: 52px;
    -o-border-radius: 52px;
    border-radius: 52px;
    -webkit-transition: margin 0.4s, background 0.4s;
    -moz-transition: margin 0.4s, background 0.4s;
    -o-transition: margin 0.4s, background 0.4s;
    transition: margin 0.4s, background 0.4s;
  }
  input.cmn-toggle-round-flat:checked + label {
    background-color: #99001a;
  }
  input.cmn-toggle-round-flat:checked + label:after {
    margin-left: 60px;
    background-color: #99001a;
  }

  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='https://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
</head>
<body>

  <div id="container">

    <h1>City Leaders</h1>
    <div id="nav">
      <a href="home">Home</a>
      <a href="signup">Sign Up</a>
    </div>

    <div id="home" class="page">
      <h2>Welcome to City Leaders</h2>
      <p>A location-based game where the goal is to accrue as many points as possible by becoming the City Leader of your current city.  Every hour that goes by that you are the City Leader you get 10 points.  And you can be the Leader of more than one city at a time.  be careful as other players from your same city will attack and try to coop your leadership.  Cities that are in contention are ones that have a population of more than 1,000 people and you must be located in or near the city to become leader.</p>
      <div id="signUpCall"><a href="signup">Click here to sign up</a></div>
    </div>

    <div id="signup" class="page">
      <h2>Join the competition</h2>
      <form>
        <label>Username<input type="text" id="username" maxlength="14" autofocus/></label><br><br>
        <button id="getCurrentPosition">Test your geolocation capabilities</button>
        <div id="foundLocation"></div><br>
        <button id="join">Click here to create your account</button>
        <div id="createUserFeedback"></div>
      </form>
    </div>

    <div id="your-portal" class="page">
      <h2>Welcome <span class='username'></span></h2>
      Your score: <span id="myPoints"></span>
      <div id="your-cities">
        Your cities:
        <ul></ul>
      </div>
    </div>

    <div id="conquer-cities" class="page">
      <div class="step1">
        Your current location: <span id="curCity"></span><br>
        <span id="nearbyCallout">Nearby cities: <span id="nearbyCities"></span></span>
      </div>
      <div class="step2" id="currentLeader">
        Current city leader: <span id="curLeader"></span>
      </div>
      <div class="step3">
        <div id="attackQ"></div>
        <button id="goForIt">Click here to take control of the city</button>
        <div id="attackResults"></div>
        <button class="reset">Click here to refresh this page and try again</button>
      </div>
    </div>

    <div id="leaderboard" class="page noselect">

      <div id="period-chooser">
        <div class="selectedPeriod"><b>Today</b></div>
        <div>
          <div class="switch">
            <input id="cmn-toggle-5" class="cmn-toggle cmn-toggle-round-flat" type="checkbox">
            <label for="cmn-toggle-5"></label>
          </div>
        </div>
        <div><b>Overall</b></div>
      </div>

      <div id="tables">
        <div class="datagrid today">
          <table>
            <thead>
              <th>#</th>
              <th>Username</th>
              <th>Points</th>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

        <div class="datagrid overall">
          <table>
            <thead>
              <th>#</th>
              <th>Username</th>
              <th>Days Won</th>
            </thead>
            <tbody>
              <td>1</td>
              <td>chiefsmurph</td>
              <td>2</td>
            </tbody>
          </table>
        </div>
      </div>


      <div id="tooltip"><h3></h3><span></span></div>
    </div>

    <div id="error" class="page">
      <b style="color: red"></b>
    </div>

  </div>

  <div class="modal" id="attackModal">
    <h2>You are attacking <span class="attackingName"></span></h2>
    ...to gain control of <span class="attackingCityName"></span>
  </div>

  <div class="modal" id="attackFailed">
    <h2><span class="attackingName"></span> blocked your attack of <span class="attackingCityName"></span></h2>
  </div>

  <div class="modal" id="attackSuccess">
    <h1>Congrats!</h1>
    <h2>You were able to steal leadership of <span class="attackingCityName"></span> from <span class="attackingName"></span></h2>
  </div>

  <div class="modal" id="dethroned">
    <h2>You have been dethroned of <span id="dethronedCity"></span> by <span id="dethronedBy"></span></h2>
  </div>

  <!-- javascript includes -->
  <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <script>
  function preload(arrayOfImages) {
      $(arrayOfImages).each(function(){
          $('<img/>')[0].src = this;
          // Alternatively you could use:
          // (new Image()).src = this;
      });
  }
  preload(['/img/loading.gif']);
  var loadingSpinner = function($where) {
    $where.html('<img src="/img/loading.gif" class="spinner" />');
    this.doneLoading = function() {
      $where.find('img.spinner').remove();
    };
  };


  (function() {

    var locationModule = {
      getCurrentCity: function(callback) {

        navigator.geolocation.getCurrentPosition(function sendPosition(position) {
          //$('#located_at').html("Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude);
          var locObj = {
            lat: position.coords.latitude,
            long: position.coords.longitude
          };
          app.set(locObj);
          socket.emit('citiesNearby', locObj);
        },function (error) {
          if (error.code == error.PERMISSION_DENIED) {
            console.log("you denied me :-(");
            callback(null, null, true);
          }
        });

        socket.once('citiesNearbyResults', function(nearbyCities) {
          console.log(nearbyCities);

          var byCities = nearbyCities.slice(0);
          if (!byCities.length) return callback(null);

          var nearestCity = byCities.shift();
          var fiveOthers = byCities.reduce(function(acc, city) {
            return acc.concat([city.cityname]);
          }, []).slice(0, 5);
          app.set({
            nearestCity: nearestCity
          });
          callback(nearestCity, fiveOthers);

        });

      }
    };

    var socket = io.connect(window.location.hostname + ":" + window.location.port);
    var app = johnsFramework({
      isMobile: (function() {
        var check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
      })(),
      state: {
        isLoggedIn: false,
        points: 0,
        cities: []
      },
      global: {
        renderNavMenu: function() {
          $('#nav').empty();
          var renderSingle = function(pageName) {
            var unHef = pageName.replace('-', ' ');
            $('#nav').append('<a href="' + pageName + '">' + unHef + '</a>');
          };
          var pagesToRender = (!app.state.isLoggedIn) ? ['home', 'signup'] : ['home', 'your-portal', 'conquer-cities', 'leaderboard'];
          pagesToRender.forEach(renderSingle);
        },
        becomeLoggedIn: function() {

          app.set({ isLoggedIn: true });
          app.cue('global.renderNavMenu');

          socket.on('pointsUpdate', function(data) {
            console.log('updated points', data);
            app.set({ points: data });
          });

          socket.emit('getfullleaderboard');

          socket.on('top10', function(data) {
            console.log('top10', data);
            app.cue('leaderboard.setAndRender', data);
          });

          socket.on('top10update', function(row) {
            console.log('top10update', row);
            app.cue('leaderboard.update', row);
          });

          // sending attack response
          var attackResponse = function(response) {
            $('#attackModal').fadeOut(300, function() {

              $('#' + response).show();
              setTimeout(function() {
                app.cue('conquer-cities.reset');
                app.forceReinit('conquer-cities');
                app.navigate.goTo('your-portal');

                $('#' + response).hide();
              }, 4000);
            });
          };

          socket.on('tookControl', function(cityObj) {
            console.log('took control iof', cityObj);
            attackResponse('attackSuccess');
            // update your-cities
            app.cue('your-portal.updateCurrentCities', app.state.cities.concat([cityObj.cityname]));
          });

          socket.on('attackFailed', function() {
            attackResponse('attackFailed');
          });


          // receiving attacks
          socket.on('beingAttacked', function(data) {
            app.cue('global.beingAttacked', data);
          });

          $('body').on('click', '.modal.beingAttacked button', function() {
            var $modal = $(this).parent();
            var attackid = $modal.data('attack-id');
            socket.emit('blockAttack', attackid);

            socket.once('attackBlockSuccess', function() {
              $modal.hide();
              $modal.remove();
            });
          });

          socket.on('dethroned', function(data) {
            console.log('you have been dethroned of ', data.cityName);
            app.cue('your-portal.updateCurrentCities', app.state.cities.filter(function(city) {
              return city !== data.cityName;
            }));
            $('.beingAttacked').remove();
            app.cue('global.displayDethronedModal', data);
            app.cue('conquer-cities.reset');
            app.forceReinit('conquer-cities');
            app.navigate.goTo('your-portal');
          });

        },
        displayDethronedModal: function(data) {
          $('#dethronedBy').html(data.thief);
          $('#dethronedCity').html(data.cityName);
          $('#dethroned').show();
          setTimeout(function() {
            $('#dethroned').hide();
          }, 3500);
        },
        beingAttacked: function(data) {
          console.log('being attacked', data);

          var $modal = $('<div class="modal beingAttacked">Your city of <b>' + data.city.cityname + '</b> is being attacked by ' + data.attacker + '<br><br><button>click here to BLOCK THE ATTACK</button></div>');
          $modal.data('attack-id', data.attackid).show();
          $('body').append($modal);
        }
      },
      init: function() {

        $(window).on(
          'touchmove',
           function(e) {
            // e.preventDefault();
          }
        );

        if (!app.isMobile) {
          $('body').addClass('no-touch');
        }

        $('button').on('click', function(e) {
          e.preventDefault();
        });

        var onLoad = function() {
          (function getPageFromUrl() {
            var page = window.location.pathname.substring(1);
            var defaultPage = (app.state.isLoggedIn) ? 'your-portal' : 'home';
            if (Object.keys(app.pages).indexOf(page) !== -1 && page !== 'error') {
              page = (app.pages[page].protected && !app.state.isLoggedIn) ? defaultPage : page;
            } else {
              page = defaultPage;
            }
            app.navigate.goTo(page);
          })();
          $('#container').show();
        };

        if (!navigator.geolocation) {
          app.navigate.goTo('error', 'You must have geolocation capabilities for this website.  Unfortunately it looks like you do not have that capability.');
        }

        var accountInfo = localStorage.getItem('accountinfo');
        if (accountInfo) {
          // returning user
          var savedInfo = JSON.parse(accountInfo);
          socket.emit('verifyUser', savedInfo);
          console.log('verifing player credentials');
          socket.once('userResponse', function(response) {
            console.log('savedinfo: ' + JSON.stringify(savedInfo));
            console.log('response: ' + JSON.stringify(response));
            if (!response) {
              onLoad();
              app.navigate.goTo('error', 'Unable to log you in.  That\'s strange');
              localStorage.removeItem('accountinfo');
              setTimeout(function() {
                window.location.reload(false);
              }, 1000);
            }
            app.set(Object.assign({}, savedInfo, response));
            app.cue('your-portal.updateCurrentCities', response.cities);
            console.log(app.state);
            app.cue('global.becomeLoggedIn');
            onLoad();

            // display each of the missedAttacks
            if (response.missedAttacks && response.missedAttacks.length) {
              (function displayDethronedModal(i) {
                app.cue('global.displayDethronedModal', response.missedAttacks[i]);
                if (i === response.missedAttacks.length - 1) {
                  return;
                }
                setTimeout(function() {
                  displayDethronedModal(++i);
                }, 4200);
              })(0);
            }
            if (response.activeAttacksOutgoing && response.activeAttacksOutgoing.length) {
              (function displayAttackingModal(i) {

                app.set({
                  attackingCityName: response.activeAttacksOutgoing[i].cityname,
                  attackingName: response.activeAttacksOutgoing[i].attacking
                });

                $('#attackModal').show();

                if (i === response.activeAttacksOutgoing.length - 1) {
                  return;
                }
                setTimeout(function() {
                  displayAttackingModal(++i);
                }, 4200);
              })(0);
            }
            response.activeAttacksIncoming.forEach(function(attack) {
              app.cue('global.beingAttacked', attack);
            });
          });

        } else {
          app.cue('global.renderNavMenu');
          onLoad();
        }

      },
      pages: {
        error: {
          init: function(message) {
            app.navigate.hasErrored = true;
            $('#error b').text(message);
          }
        },
        home: {
          init: function() {
              $('#signUpCall').toggle(!app.state.isLoggedIn);
          }
        },
        signup: {
          dom: {
            username: {
              el: '#username'
            }
          },
          init: function() {
            // alert('sign up');

            $('#getCurrentPosition').one('click', function() {

              var loading = new loadingSpinner($('#foundLocation'));

              locationModule.getCurrentCity(function(nearestCity, fiveOthers, err) {
                if (err) {
                  return $('#foundLocation').html('Looks like you have geolocation capabilities but have been disabled for this website or app.  Look for your location settings and try again.').addClass('red');
                }
                if (!nearestCity) {
                  return $('#foundLocation').html('That\'s strange.  We were unable to find you.  Go somewhere else.').addClass('red');
                }
                var html = 'Great! Your geolocation seems to be working well.<br>We found you in ' + nearestCity.cityname + '.';
                html += (fiveOthers.length) ? '<br>Cities nearby: ' + fiveOthers.join(', ') : '';
                $('#foundLocation').html(html).removeClass('red').addClass('green');
                $('#join').show();
                $('#getCurrentPosition').remove();
              });

            });

            var $username = this.$username;
            $username.focus();
            $('#join').one('click', function() {

              var loading = new loadingSpinner($('#createUserFeedback'));

              var username = $username.val();
              var locationString = app.state.nearestCity.cityname + ', ' + app.state.nearestCity.admincode + ' (' + app.state.nearestCity.country + ')';
              console.log('join', username, locationString);
              socket.emit('newUser', {
                username: username,
                lat: app.state.lat,
                long: app.state.long,
                nearestCity: locationString
              });

              socket.once('createUserError', function(errText) {
                $('#createUserFeedback').text(errText).addClass("red");
              });

              socket.once('createUserSuccess', function(data) {
                console.log(data);
                $('#createUserFeedback').text('Successfully created your account.').addClass("green");
                app.set(Object.assign({}, app.state, data));
                localStorage.setItem('accountinfo', JSON.stringify(data));
                app.cue('global.becomeLoggedIn');
                setTimeout(function() {
                  app.navigate.goTo('your-portal');
                }, 1000);
              });
            });

          }
        },
        'your-portal': {
          protected: true,
          dom: {
            myPoints: {
              el: '#myPoints',
              map: 'points'
            },
            username: {
              el: '.username',
              map: 'username'
            }
          },
          init: function() {
            // $('.username').text(app.state.username);
          },
          updateCurrentCities: function(cities) {
            app.set({ cities: cities });
            console.log(cities,'cities')
            $('#your-cities').toggle(!!cities.length);
            $('#your-cities ul').html(cities.map(function(city) {
              return '<li>' + city + '</li>';
            }));
          }
        },
        'conquer-cities': {
          protected: true,
          dom: {
            attackingName: {
              el: '.attackingName',
              map: 'attackingName'
            },
            attackingCityName: {
              el: '.attackingCityName',
              map: 'attackingCityName'
            }
          },
          init: function() {
            this.reset();

            var spinners = [];
            spinners.stop = function() {
              this.forEach(function(spinner) {
                spinner.doneLoading();
              });
            };

            // step 1: get current location
            ['curCity', 'nearbyCities'].forEach(function(id) {
              spinners.push(new loadingSpinner($('#' + id)));
            });

            locationModule.getCurrentCity(function(nearestCity, fiveOthers) {
              spinners.stop();
              if (nearestCity) {
                $('#curCity').text(nearestCity.cityname);
                $('#nearbyCities').text(fiveOthers.join(', '));
                setTimeout(stepTwo, 800);
              }
            });

            var stepTwo = function() {
              // step two
              $('#conquer-cities .step2').show();
              spinners.push(new loadingSpinner($('#conquer-cities .step2 #curLeader')));

              socket.emit('getCurrentLeader', app.state.nearestCity.cityid);

              socket.once('currentLeaderFeedback', function(leader) {
                app.set({curLeader: leader});
                leader = (leader) ? leader.username : null;
                spinners.stop();
                $('#conquer-cities .step3').show();
                if (!leader) {
                  $('#conquer-cities .step2 #curLeader').text('No current leader');
                  $('#conquer-cities .step3 #attackQ').text('Would you like to become leader of the city?');
                  $('#conquer-cities .step3 button#goForIt').data('conquer-type', 'usurp');
                } else if (leader === app.state.username) {
                  $('#conquer-cities .step3 #attackQ').text('You are already the leader of this city.  Go off and conquer more cities.');
                  $('#conquer-cities .step2 #curLeader').text(leader);
                  $('#conquer-cities .step3 #attackQ').addClass('green');
                  $('#conquer-cities .step3 button#goForIt').hide();
                  $('#conquer-cities button.reset').show();
                } else {
                  $('#conquer-cities .step2 #curLeader').text(leader);
                  $('#conquer-cities .step3 #attackQ').text('Would you like to try to take over the city in a coup?');
                  $('#conquer-cities .step3 button#goForIt').text('Click here to attack the leadership of ' + leader);
                  $('#conquer-cities .step3 button#goForIt').data('conquer-type', 'attack');
                }
              });

              $('#conquer-cities .step3 button#goForIt').one('click', function() {
                if ($(this).data('conquer-type') === 'usurp') {
                  console.log('conqieruing')
                  socket.emit('conquerCity', app.state.nearestCity);

                  spinners.push(new loadingSpinner($('#conquer-cities #attackResults')));

                  socket.once('conquerResponse', function(data) {
                    spinners.stop();
                    console.log(data);
                    $('#conquer-cities .step3 button#goForIt').hide();
                    $('#conquer-cities button.reset').show();
                    if (!data) {
                      return $('#conquer-cities #attackResults').html('Uh oh looks like someone else already snagged this city.').addClass('red');
                    }
                    $('#conquer-cities #attackResults').html('Congrats!  You are now the leader of ' + data.cityname + ' and you will accumulate 10 points every hour.  But don\'t stop here.  Go out and conquer more lands').addClass('green');
                    app.cue('your-portal.updateCurrentCities', app.state.cities.concat([data.cityname]));
                    setTimeout(function() {
                      if (app.navigate.curPage === 'conquer-cities') {
                        app.navigate.goTo('your-portal');
                      }
                      app.forceReinit('conquer-cities');
                    }, 2000);
                  });
                } else {

                  socket.emit('attackCity', {
                    city: app.state.nearestCity,
                    leader: app.state.curLeader.leaderid
                  });

                  new loadingSpinner($('#conquer-cities #attackResults'));

                  socket.once('attackError', function(data) {
                    $('#conquer-cities .step3 button#goForIt').hide();
                    $('#conquer-cities button.reset').show();
                    $('#conquer-cities #attackResults').html(data).addClass('red');
                  });

                  socket.once('attackConfirm', function(data) {
                    $('#conquer-cities #attackResults').html('Attack confirmed').addClass('green');

                    app.set({
                      attackingCityName: app.state.nearestCity.cityname,
                      attackingName: app.state.curLeader.username
                    });

                    setTimeout(function() {
                      $('#attackModal').show();
                    }, 600);

                  });



                }

              });

            };

            $('#conquer-cities').on('click', 'button.reset', function() {
              app.cue('conquer-cities.reset');
              app.forceReinit('conquer-cities');
              app.navigate.goTo('conquer-cities');
            });

          },

          reset: function() {
            $('.step2, .step3').hide();
            $('#conquer-cities .step1').show();
            $('#conquer-cities .step3 button#goForIt').show();
            $('#attackResults').html('');
            $('#conquer-cities button.reset').hide();
          }

        },
        'leaderboard': {
          protected: true,

          dom: {
            tooltipbox: {
              el: '#leaderboard #tooltip'
            },
            tooltipname: {
              el: '#leaderboard #tooltip h3',
              map: 'tooltipname'
            },
            tooltipbody: {
              el: '#leaderboard #tooltip span',
              map: 'tooltipbody'
            }
          },

          'top10': [],

          renderTop10: function() {
            var $tbody = $('#leaderboard .today tbody');
            $tbody.empty();
            this.top10.forEach(function(row, i) {
              $tbody.append('<tr><td>' + (i + 1) + '</td><td><span>' + row.username + '</span></td><td>' + row.points + '</td></tr>');
            });

            $('#leaderboard .today tbody td:contains(' + app.state.username + ')').parent().css('background-color', 'yellow');

            var maxTableHeight = Math.max(parseInt($('#tables .today').height()), parseInt($('#tables .overall').height()));
            $('#tables').css('height', maxTableHeight + 'px');
          },

          setAndRender: function(data) {
            this.top10 = data;
            this.renderTop10();
          },
          update: function(row) {
            console.info(row);
            var top10 = this.top10;
            var index = (function getRelatedIndex() {
              for (var i = 0; i < top10.length; i++) {
                // debugger;
                if (top10[i].username === row.username) {
                  return i;
                }
              }
              return -1;
            })();
            if (index === -1) {
              this.top10.push(row);
              return console.log('new user to the leaderboard');
            }
            this.top10[index] = Object.assign({}, this.top10[index], row);
            this.top10.sort(function(a, b) {
              return b.points - a.points;
            });
            this.renderTop10();
          },
          getCitiesForUsername: function(username) {
            // debugger;
            var found = this.top10.filter(function(row) {
              return row.username === username;
            });
            return (found.length) ? found[0].cities : [];
          },
          init: function() {

            var $todayTable = $('.datagrid.today');
            var $overallTable = $('.datagrid.overall')
            $('#cmn-toggle-5').on('change', function() {
              var selected = $('.selectedPeriod').index();
              var other = (selected === 0) ? 2 : 0;
              if (selected === 0) {
                $todayTable.stop().fadeOut(500);
                $overallTable.stop().fadeIn(500);
                other = 2;
              } else {
                $overallTable.stop().fadeOut(500);
                $todayTable.stop().fadeIn(500);
                other = 0;
              }

              console.log(selected, other);
              $('#period-chooser > div').removeClass('selectedPeriod').eq(other).addClass('selectedPeriod');
            });

            $('#period-chooser').on('click', 'div:not(.selectedPeriod) b', function() {
              $('#cmn-toggle-5').click();
            });

            (function setupTooltips($ttBox, top10) {

              $ttBox.hide();

              var getSetAndShowTT = function(username) {
                var cities = app.pages.leaderboard.getCitiesForUsername(username);
                app.set({
                  tooltipname: username,
                  tooltipbody: (cities.length) ? cities.join('<br>') : 'No cities'
                });
                $ttBox.show();
              };

              if (app.isMobile) {
                $ttBox.addClass('modal');
                $ttBox.on('click', function() {
                  $ttBox.hide();
                });
                $('#leaderboard table').on('mousedown', 'td span', function() {
                  var username = $(this).text();
                  getSetAndShowTT(username);
                });
                $('#leaderboard table').on('mouseup', 'td span', function() {
                  $ttBox.hide();
                });
                return;
              }

              var lagInHide = false;
              $('#leaderboard table').on('mouseover', 'td span', function() {
                var username = $(this).text();
                getSetAndShowTT(username);

                $(this).on('mousemove', function(evt) {
                  $ttBox.css({
                    top: evt.pageY,
                    left: evt.pageX + 25
                  });
                });
                lagInHide = true;
              });
              $('#leaderboard table').on('mouseout', 'td span', function(evt) {
                lagInHide = false;
                setTimeout(function() {
                  if (!lagInHide) {
                    $ttBox.hide();
                  }
                }, 200);
              });
            })(this.$tooltipbox, this.top10);


          }
        }
      }

    });

    app.init();

  })();




  function johnsFramework(app) {

    // register all page dom elements to watch for when state changes
    var $watchState = {};
    (function registerWatchStateVars() {
      Object.keys(app.pages).map(function(pageName) {
        var page = app.pages[pageName];
        if (page.dom) {
          Object.keys(page.dom).forEach(function(dom) {
            var domObj = page.dom[dom];
            app.pages[pageName]['$' + dom] = $(domObj.el);
            $watchState[domObj.map] = app.pages[pageName]['$' + dom];
          });
        }
        return page;
      });
    })();

    // when setting update innerhtml of related fields
    app.set = function(stateUpdate) {
      Object.keys(stateUpdate).forEach(function(stateKey) {
        if ($watchState[stateKey]) {
          $watchState[stateKey].html(stateUpdate[stateKey]);
        }
      });
      app.state = Object.assign({}, app.state, stateUpdate);
    };

    app.set(app.state);

    app.cue = function(what, data) {
      var args = Array.prototype.slice.call(arguments);
      var what = args.shift();
      var split = what.split('.');
      var page = split[0];
      var fnName = split[1];
      console.log('cueing ' + page + ' ' + fnName);
      var relatedModule = (page === 'global') ? app.global : app.pages[page];
      var fn = relatedModule[fnName];
      return fn.apply(relatedModule, args);
    };

    var pagesToForce = {};
    app.forceReinit = function(page) {
      pagesToForce[page] = true;
    };

    app.navigate = {
      curPage: null,
      hasErrored: false,
      pagesVisited: {},
      goTo: function(page, value) {
        if (this.hasErrored) return;

        $('.page').hide();

        if (app.pages[page] && app.pages[page].init && (!this.pagesVisited[page] || pagesToForce[page]) ) {
          // only runs the first time the page is accessed unless pagesToForce[page]
          app.pages[page].init(value);
          delete pagesToForce[page];
        }


        $('#' + page + '.page').show();

        // updates navigation with selected currentPage
        var unHef = page.replace('-', ' ');
        $('#nav a').removeClass('currentPage');
        $('#nav a:contains(' + unHef + ')').addClass("currentPage");

        history.pushState({}, unHef, page);

        function toTitleCase(str)
        {
            return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        }

        $(document).prop('title','City Leaders | ' + toTitleCase(unHef));
        this.pagesVisited[page] = true;
        this.curPage = page;
      }
    };

    $(document).on('click', 'a', function(e) {
      if ($(this).hasClass('btn')) {
        return;
      }
      var href = $(this).attr('href');
      app.navigate.goTo(href);
      e.preventDefault();
    });

    return app;

  }




  </script>
</body>
</html>
