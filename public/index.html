<html>
<head>
  <title>Cities distance</title>
  <Style>
  h1, p {
    margin: 0;
  }
  p {
    margin-bottom: 1em;
  }
  #nearbyCitiesView {
    display: none;
  }
  body * {
    font-family: 'Audiowide', cursive;
  }
  body {
    padding: 10px;
  }
  #nav {
    display: flex;
    justify-content: space-around;
    margin: 0 -10px 10px;
  }
  #nav a {
    background-color: #eee;
    padding: 10px;
    margin: 0.4vw;
    flex-grow: 1;
    text-align: center;
    color: blue;
  }
  #nav a:hover {
    background-color: #ccc;
  }
  #nav a.currentPage {
    background-color: #ccc;
  }
  #container {
    display: none;
    font-size: 130%;
  }

  @media (max-width: 800px) {
    #container {
      font-size: 18px;
    }
  }


  form {

  }
  label input {
    margin-left: 10px;
  }
  button {
    font-size: 16px;
    padding: 5px 35px;
  }
  button#join {
    display: none;
    font-weight: bold;
  }
  #getCurrentPosition {
    margin-bottom: 10px;
  }
  .red {
    color: red;
  }
  .green {
    color: green;
  }
  #curCity {
    font-weight: bold;
    font-size: 135%;
    color: green;
  }
  #nearbyCallout {
    font-size: 80%;
    color: grey;
    font-style: italic;
  }
  #conquer-cities > div {
    margin-bottom: 1em;
  }
  #conquer-cities button {
    margin-top: 4px;
  }
  #leaderboard {
    font-size: 150%;
  }
  #leaderboard thead {
    letter-spacing: 2px;
  }
  .datagrid table { border-collapse: collapse; text-align: left; width: 100%; } .datagrid {font: normal 12px/150% Arial, Helvetica, sans-serif; background: #fff; overflow: hidden; border: 1px solid #006699; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; }.datagrid table td, .datagrid table th { padding: 3px 10px; }.datagrid table thead th {background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #006699), color-stop(1, #00557F) );background:-moz-linear-gradient( center top, #006699 5%, #00557F 100% );filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#006699', endColorstr='#00557F');background-color:#006699; color:#ffffff; font-weight: bold; border-left: 1px solid #0070A8; } .datagrid table thead th:first-child { border: none; }.datagrid table tbody td { color: #00496B; border-left: 1px solid #E1EEF4;font-weight: normal; }.datagrid table tbody .alt td { background: #E1EEF4; color: #00496B; }.datagrid table tbody td:first-child { border-left: none; }.datagrid table tbody tr:last-child td { border-bottom: none; }.datagrid table tfoot td div { border-top: 1px solid #006699;background: #E1EEF4;} .datagrid table tfoot td { padding: 0; font-size: 12px } .datagrid table tfoot td div{ padding: 2px; }.datagrid table tfoot td ul { margin: 0; padding:0; list-style: none; text-align: right; }.datagrid table tfoot  li { display: inline; }.datagrid table tfoot li a { text-decoration: none; display: inline-block;  padding: 2px 8px; margin: 1px;color: #FFFFFF;border: 1px solid #006699;-webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #006699), color-stop(1, #00557F) );background:-moz-linear-gradient( center top, #006699 5%, #00557F 100% );filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#006699', endColorstr='#00557F');background-color:#006699; }.datagrid table tfoot ul.active, .datagrid table tfoot ul a:hover { text-decoration: none;border-color: #006699; color: #FFFFFF; background: none; background-color:#00557F;}div.dhtmlx_window_active, div.dhx_modal_cover_dv { position: fixed !important; }
  </style>

  <link href='https://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
</head>
<body>

  <div id="container">

    <h1>City Leaders</h1>
    <div id="nav">
      <a href="home">Home</a>
      <a href="signup">Sign Up</a>
    </div>

    <div id="home" class="page">
      <h2>Welcome to City Leaders</h2>
      <p>A location-based game where the goal is to accrue as many points as possible by becoming the City Leader of your current city.  Every hour that goes by that you are the City Leader you get 10 points.  And you can be the Leader of more than one city at a time.  be careful as other players from your same city will attack and try to coop your leadership.  Cities that are in contention are ones that have a population of more than 1,000 people and you must be located in or near the city to become leader.</p>
      <div id="signUpCall"><a href="signup">Click here to sign up</a></div>
    </div>

    <div id="signup" class="page">
      <h2>Join the competition</h2>
      <form>
        <label>Username<input type="text" id="username"/></label><br><br>
        <button id="getCurrentPosition">Test your geolocation capabilities</button>
        <div id="foundLocation"></div><br>
        <button id="join">Click here to create your account</button>
        <div id="createUserFeedback"></div>
      </form>
    </div>

    <div id="your-portal" class="page">
      <h2>Welcome <span class='username'></span></h2>
      Your score: <span id="myPoints"></span>
    </div>

    <div id="conquer-cities" class="page">
      <div class="step1">
        Your current location: <span id="curCity"></span><br>
        <span id="nearbyCallout">Nearby cities: <span id="nearbyCities"></span></span>
      </div>
      <div class="step2" id="currentLeader">
        Current city leader: <span id="curLeader"></span>
      </div>
      <div class="step3">
        <div id="attackQ"></div>
        <button>Click here to take control of the city</button>
        <div id="attackResults"></div>
      </div>
    </div>

    <div id="leaderboard" class="page datagrid">
      <table>
        <thead>
          <th>Username</th>
          <th>Points</th>
        </thead>
        <tbody>
        </tbody>
    </div>

    <div id="error" class="page">
      <b style="color: red"></b>
    </div>

  </div>


  <!-- javascript includes -->
  <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  
  <script>
  var loadingSpinner = function($where) {
    $where.html('<img src="/img/loading.gif" class="spinner" />');
    this.doneLoading = function() {
      $where.find('img.spinner').remove();
    };
  };


  (function() {

    var locationModule = {
      getCurrentCity: function(callback) {

        navigator.geolocation.getCurrentPosition(function sendPosition(position) {
          //$('#located_at').html("Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude);
          var locObj = {
            lat: position.coords.latitude,
            long: position.coords.longitude
          };
          app.set(locObj);
          socket.emit('citiesNearby', locObj);
        });

        socket.once('citiesNearbyResults', function(nearbyCities) {
          console.log(nearbyCities);

          var byCities = nearbyCities.slice(0);
          if (!byCities.length) return callback(null);

          var nearestCity = byCities.shift();
          var fiveOthers = byCities.reduce(function(acc, city) {
            return acc.concat([city.cityname]);
          }, []).slice(0, 5);
          app.set({
            nearestCity: nearestCity
          });
          callback(nearestCity, fiveOthers);

        });

      }
    };

    var socket = io.connect(window.location.hostname + ":" + window.location.port);
    var app = johnsFramework({
      state: {
        isLoggedIn: false
      },
      global: {
        renderNavMenu: function() {
          $('#nav').empty();
          var renderSingle = function(pageName) {
            var unHef = pageName.replace('-', ' ');
            $('#nav').append('<a href="' + pageName + '">' + unHef + '</a>');
          };
          var pagesToRender = (!app.state.isLoggedIn) ? ['home', 'signup'] : ['home', 'your-portal', 'conquer-cities', 'leaderboard'];
          pagesToRender.forEach(renderSingle);
        },
        becomeLoggedIn: function() {

          app.set({ isLoggedIn: true });
          app.cue('global.renderNavMenu');

          socket.on('pointsUpdate', function(data) {
            console.log('updated points', data);
            app.set({ points: data });
          });

          socket.emit('getfullleaderboard');

          socket.on('top10', function(data) {
            console.log('top10', data);
            app.pages.leaderboard.setAndRender(data);
          });

          socket.on('top10scoreupdate', function(row) {
            app.pages.leaderboard.updateScore(row);
          });

        }
      },
      init: function() {

        $('button').on('click', function(e) {
          e.preventDefault();
        });

        var onLoad = function() {
          (function getPageFromUrl() {
            var page = window.location.pathname.substring(1);
            var defaultPage = (app.state.isLoggedIn) ? 'your-portal' : 'home';
            if (Object.keys(app.pages).indexOf(page) !== -1 && page !== 'error') {
              page = (app.pages[page].protected && !app.state.isLoggedIn) ? defaultPage : page;
            } else {
              page = defaultPage;
            }
            app.navigate.goTo(page);
          })();
          $('#container').show();
        };

        if (!navigator.geolocation) {
          app.navigate.goTo('error', 'You must have geolocation capabilities for this website.  Unfortunately it looks like you do not have that capability.');
        }

        var accountInfo = localstorage.getItem('accountinfo');
        if (accountInfo) {
          // returning user
          var savedInfo = JSON.parse(accountInfo);
          socket.emit('verifyUser', savedInfo);
          console.log('verifing player credentials');
          socket.once('userResponse', function(response) {
            console.log('savedinfo: ' + JSON.stringify(savedInfo));
            console.log('response: ' + JSON.stringify(response));
            if (response) {
              app.set(Object.assign({}, savedInfo, response));
              console.log(app.state);
              app.cue('global.becomeLoggedIn');
              onLoad();
            } else {
              onLoad();
              app.navigate.goTo('error', 'Unable to log you in.  That\'s strange');
            }
          });

        } else {
          app.cue('global.renderNavMenu');
          onLoad();
        }

      },
      pages: {
        error: {
          init: function(message) {
            app.navigate.hasErrored = true;
            $('#error b').text(message);
          }
        },
        home: {
          init: function() {
              $('#signUpCall').toggle(!app.state.isLoggedIn);
          }
        },
        signup: {
          init: function() {
            // alert('sign up');

            $('#getCurrentPosition').one('click', function() {

              locationModule.getCurrentCity(function(nearestCity, fiveOthers) {
                if (!nearestCity) {
                  return $('#foundLocation').html('That\'s strange.  We were unable to find you');
                }
                var html = 'Great! Your geolocation seems to be working well.<br>We found you in ' + nearestCity.cityname + '.';
                html += (fiveOthers.length) ? '<br>Cities nearby: ' + fiveOthers.join(', ') : '';
                $('#foundLocation').html(html);
                $('#join').show();
                $('#getCurrentPosition').remove();
              });

            });

            $('#join').one('click', function() {
              debugger;
              var username = $('#username').val();
              var locationString = app.state.nearestCity.cityname + ', ' + app.state.nearestCity.admincode + ' (' + app.state.nearestCity.country + ')';
              debugger;
              socket.emit('newUser', {
                username: username,
                lat: app.state.lat,
                long: app.state.long,
                nearestCity: locationString
              });

              socket.once('createUserError', function(errText) {
                $('#createUserFeedback').text(errText).addClass("red");
              });

              socket.once('createUserSuccess', function(data) {
                console.log(data);
                $('#createUserFeedback').text('Successfully created your account.').addClass("green");
                app.set(Object.assign({}, app.state, data));
                localstorage.setItem('accountinfo', JSON.stringify(data));
                app.cue('global.becomeLoggedIn');
                setTimeout(function() {
                  app.navigate.goTo('your-portal');
                }, 1000);
              });
            });

          }
        },
        'your-portal': {
          protected: true,
          dom: {
            myPoints: {
              el: '#myPoints',
              map: 'points'
            }
          },
          init: function() {
            $('.username').text(app.state.username);
          }
        },
        'conquer-cities': {
          protected: true,
          init: function() {
            $('.step2, .step3').hide();
            $('#conquer-cities .step1').show();

            var spinners = [];
            spinners.stop = function() {
              this.forEach(function(spinner) {
                spinner.doneLoading();
              });
            };
            var nearestTo;

            // step 1: get current location
            ['curCity', 'nearbyCities'].forEach(function(id) {
              spinners.push(new loadingSpinner($('#' + id)));
            });

            locationModule.getCurrentCity(function(nearestCity, fiveOthers) {
              spinners.stop();
              if (nearestCity) {
                nearestTo = nearestCity;
                $('#curCity').text(nearestCity.cityname);
                $('#nearbyCities').text(fiveOthers.join(', '));

                setTimeout(stepTwo, 1000);
              }
            });

            var stepTwo = function() {
              // step two
              $('#conquer-cities .step2').show();
              spinners.push(new loadingSpinner($('#conquer-cities .step2 #curLeader')));

              socket.emit('getCurrentLeader', nearestTo.cityid);

              socket.once('currentLeaderFeedback', function(leader) {
                spinners.stop();
                $('#conquer-cities .step3').show();
                if (!leader) {
                  $('#conquer-cities .step2 #curLeader').text('No current leader');
                  $('#conquer-cities .step3 #attackQ').text('Would you like to become leader of the city?');
                } else if (leader === app.state.username) {
                  $('#conquer-cities .step3 #attackQ').text('You are already the leader of this city.  Go off and conquer more cities.');
                  $('#conquer-cities .step2 #curLeader').text(leader);
                  $('#conquer-cities .step3 #attackQ').addClass('green');
                  $('#conquer-cities .step3 button').hide();
                } else {
                  $('#conquer-cities .step2 #curLeader').text(leader);
                  $('#conquer-cities .step3 #attackQ').text('Would you like to try to take over the city in a coup?');
                  $('#conquer-cities .step3 button').text('Click here to attack the leadership of ' + leader);
                }
              });

              $('#conquer-cities button').one('click', function() {
                console.log('conqieruing')
                socket.emit('conquerCity', nearestTo);

                spinners.push(new loadingSpinner($('#conquer-cities #attackResults')));

                socket.once('conquerResponse', function(data) {
                  spinners.stop();
                  console.log(data);
                  $('#conquer-cities #attackResults').html('Congrats, you are now the leader of ' + data.cityname + ' and you will accumulate 10 points every hour.  But don\'t stop here.  Go out and conquer more lands');
                });
              });

            }

          }
        },
        'leaderboard': {

          'top10': [],

          renderTop10: function() {
            var $tbody = $('#leaderboard tbody');
            $tbody.empty();
            this.top10.forEach(function(row) {
              $tbody.append('<tr><td>' + row.username + '</td><td>' + row.points + '</td></tr>');
            });
          },

          setAndRender: function(data) {
            this.top10 = data;
            this.renderTop10();
          },

          updateScore: function(row) {
            console.log(row);
            var foundScore = this.top10.filter(function(data) {
              return data.username === row.username;
            });
            debugger;
            if (foundScore.length) {
              foundScore[0].points = row.points;
            } else {
              this.top10.push(row);
              this.top10.sort(function(a, b) {
                return a.points > b.points;
              });
            }
            this.renderTop10();
          }

        }
      }

    });

    app.init();

  })();




  function johnsFramework(app) {

    // register all page dom elements to watch for when state changes
    var $watchState = {};
    (function registerWatchStateVars() {
      Object.keys(app.pages).map(function(pageName) {
        var page = app.pages[pageName];
        if (page.dom) {
          Object.keys(page.dom).forEach(function(dom) {
            var domObj = page.dom[dom];
            app.pages[pageName]['$' + dom] = $(domObj.el);
            $watchState[domObj.map] = app.pages[pageName]['$' + dom];
          });
        }
        return page;
      });
    })();

    // when setting update innerhtml of related fields
    app.set = function(stateUpdate) {
      Object.keys(stateUpdate).forEach(function(stateKey) {
        if ($watchState[stateKey]) {
          $watchState[stateKey].html(stateUpdate[stateKey]);
        }
      });
      app.state = Object.assign({}, app.state, stateUpdate);
    };

    app.cue = function(what) {
      var split = what.split('.');
      var page = split[0];
      var fnName = split[1];
      console.log('cueing ' + page + ' ' + fnName);
      app[page][fnName]();
    };

    app.navigate = {
      hasErrored: false,
      pagesVisited: {},
      goTo: function(page, value) {
        if (this.hasErrored) return;

        $('.page').hide();

        if (app.pages[page] && app.pages[page].init && !this.pagesVisited[page]) {
          // only runs the first time the page is accessed
          app.pages[page].init(value);
        }

        $('#' + page + '.page').show();

        // updates navigation with selected currentPage
        var unHef = page.replace('-', ' ');
        $('#nav a').removeClass('currentPage');
        $('#nav a:contains(' + unHef + ')').addClass("currentPage");

        history.pushState({}, unHef, page);
        this.pagesVisited[page] = true;
      }
    };

    $('#nav').on('click', 'a', function(e) {
      var href = $(this).attr('href');
      app.navigate.goTo(href);
      e.preventDefault();
    });

    return app;

  }




  </script>
</body>
</html>
